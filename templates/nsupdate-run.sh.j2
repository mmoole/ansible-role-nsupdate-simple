#!/bin/bash

# generated by ansible for host {{ inventory_hostname }}
# script initially written by https://ma-tty.blogspot.de/2011/12/centos-as-dynamic-dns-client-in-active.html

# this updates without keys which could be used for extendes security
# see also http://linux.yyz.us/nsupdate/

set -ex

# check required tools
command -v nsupdate >/dev/null 2>&1 || { echo >&2 "this script requires nsupdate but it's not installed."; exit 1; }

FQDN=$(hostname -f)

# get variables from /etc/sysconfig/network
. /etc/sysconfig/network

DNSSERVER=$DNS1

# Get vars from interface config file
# . /etc/sysconfig/network-scripts/ifcfg-eth0

IPADDR=$(hostname -I | cut -d" " -f 1)

IP=(${IPADDR//./ })
IPREV=${IP[3]}.${IP[2]}.${IP[1]}.${IP[0]}
#PTR_UPDATE_RR="update add $IPREV.in-addr.arpa {{ nsupdate_ttl }} PTR $FQDN."
PTR_UPDATE_RR="update add $IPREV {{ nsupdate_ttl }} PTR $FQDN."

#Must be no empty lines in nsupdate command file

cat <<EOF | nsupdate
server $DNSSERVER
prereq nxrrset $FQDN. CNAME
update delete $FQDN. A
update add $FQDN. {{ nsupdate_ttl }} A $IPADDR
;show
send
EOF

cat <<EOF | nsupdate
server $DNSSERVER
$PTR_UPDATE_RR
;show
send
EOF

touch "/tmp/nsupdate-ended_$(date -u)"
